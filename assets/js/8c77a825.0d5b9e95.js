"use strict";(self.webpackChunklrvinye_blog=self.webpackChunklrvinye_blog||[]).push([[31],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return d}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function c(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)t=s[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),l=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=l(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),m=l(t),d=r,f=m["".concat(i,".").concat(d)]||m[d]||p[d]||s;return t?a.createElement(f,o(o({ref:n},u),{},{components:t})):a.createElement(f,o({ref:n},u))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,o=new Array(s);o[0]=m;var c={};for(var i in n)hasOwnProperty.call(n,i)&&(c[i]=n[i]);c.originalType=e,c.mdxType="string"==typeof e?e:r,o[1]=c;for(var l=2;l<s;l++)o[l]=t[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},7687:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return c},contentTitle:function(){return i},metadata:function(){return l},toc:function(){return u},default:function(){return m}});var a=t(7462),r=t(3366),s=(t(7294),t(3905)),o=["components"],c={title:"\u5728K8S\u4e0a\u90e8\u7f72ES\u96c6\u7fa4",date:new Date("2020-06-22T14:52:35.000Z"),category:"\u8fd0\u7ef4",tags:["k8s","\u8fd0\u7ef4","\u5b89\u88c5","\u914d\u7f6e","\u641c\u7d22\u5f15\u64ce","ES","ElasticSearch"]},i="\u73af\u5883",l={unversionedId:"devops/buildElasticSearchOnK8S",id:"devops/buildElasticSearchOnK8S",isDocsHomePage:!1,title:"\u5728K8S\u4e0a\u90e8\u7f72ES\u96c6\u7fa4",description:"`yml",source:"@site/docs/devops/buildElasticSearchOnK8S.md",sourceDirName:"devops",slug:"/devops/buildElasticSearchOnK8S",permalink:"/blog/docs/devops/buildElasticSearchOnK8S",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/devops/buildElasticSearchOnK8S.md",version:"current",frontMatter:{title:"\u5728K8S\u4e0a\u90e8\u7f72ES\u96c6\u7fa4",date:"2020-06-22T14:52:35.000Z",category:"\u8fd0\u7ef4",tags:["k8s","\u8fd0\u7ef4","\u5b89\u88c5","\u914d\u7f6e","\u641c\u7d22\u5f15\u64ce","ES","ElasticSearch"]},sidebar:"devops",previous:{title:"\u901a\u8fc7Docker\u90e8\u7f72 Bitwarden_rs",permalink:"/blog/docs/devops/buildBitwardenRsByDocker"},next:{title:"\u901a\u8fc7 Docker \u6216 K8S \u90e8\u7f72 Kong \u7f51\u5173",permalink:"/blog/docs/devops/buildKongGatewayByDockerOrK8s"}},u=[{value:"Service",id:"service",children:[]},{value:"StatefulSet",id:"statefulset",children:[]}],p={toc:u};function m(e){var n=e.components,t=(0,r.Z)(e,o);return(0,s.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"\u73af\u5883"},"\u73af\u5883"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yml"},"#\u8fd9\u91cc\u7684K8S\u662f\u90e8\u7f72\u7684\u817e\u8baf\u4e91 TKE \u5bb9\u5668\u670d\u52a1\n\nK8S:\n  Master: 1.16.3-tke.6\n  Node: 1.16.3-tke.8\n  \u8fd0\u884c\u65f6\u7ec4\u4ef6: containerd\n\n  #ElasticSearch 7.3.2\ndocker:\n  image: ElasticSearch:7.3.2\n")),(0,s.kt)("h1",{id:"\u521b\u5efa-es-\u914d\u7f6e\u6587\u4ef6\u7684-configmap\uff1a"},"\u521b\u5efa ES \u914d\u7f6e\u6587\u4ef6\u7684 configmap\uff1a"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'# cat es-cm.yml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: es\n  namespace: ns\ndata:\n  elasticsearch.yml: |\n    cluster.name: "${NAMESPACE}"\n    node.name: "${POD_NAME}"\n    network.host: 0.0.0.0\n    discovery.seed_hosts: "es-in" #\u5185\u90e8\u901a\u4fe1\u670d\u52a1\n    cluster.initial_master_nodes: "es-0,es-1,es-2" #\u4e09\u4e2apod\n')),(0,s.kt)("h1",{id:"yaml-\u6784\u5efa"},"YAML \u6784\u5efa"),(0,s.kt)("h2",{id:"service"},"Service"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"# \u96c6\u7fa4\u5185\u90e8\u8282\u70b9\u901a\u4fe1\u4f7f\u7528\napiVersion: v1\nkind: Service\nmetadata:\n  name: es-in\n  namespace: ns\n  labels:\n    k8s-app: es\nspec:\n  selector:\n    k8s-app: es\n  clusterIP: None\n  ports:\n    - name: in\n      port: 9300\n      protocol: TCP\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"#\u5916\u90e8\u8c03\u7528\u670d\u52a1\u4f7f\u7528\napiVersion: v1\nkind: Service\nmetadata:\n  name: es-out\n  namespace: ns\n  labels:\n    k8s-app: es\nspec:\n  selector:\n    k8s-app: es\n  ports:\n    - name: out\n      port: 9200\n      protocol: TCP\n")),(0,s.kt)("h2",{id:"statefulset"},"StatefulSet"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yaml"},"# es-statefulset.yml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: es\n  namespace: ns\n  labels:\n    k8s-app: es\nspec:\n  replicas: 3 #3\u4e2a\u8282\u70b9\n  serviceName: es\n  selector:\n    matchLabels:\n      k8s-app: es\n  template:\n    metadata:\n      labels:\n        k8s-app: es\n    spec:\n      containers:\n      - name: es\n        image: elasticsearch:7.3.2\n        command: #\u4fee\u6539 vm.max_map_count \u4ee5\u8fbe\u5230\u6700\u4f4e\u4f7f\u7528\u6807\u51c6\n        - bash\n        - -c\n        - ulimit -l unlimited && sysctl -w vm.max_map_count=262144 && chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data && exec su elasticsearch docker-entrypoint.sh\n        env:\n          - name: NAMESPACE\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.namespace\n          - name: POD_NAME\n            valueFrom:\n              fieldRef:\n                fieldPath: metadata.name\n          - name: ES_HEAP_SIZE\n            value: 512m\n          - name: ES_JAVA_OPTS\n            value: -Xms512m -Xmx512m\n          - name: path.data #\u6301\u4e45\u5316\u50a8\u5b58 \u591a\u8282\u70b9\u7684\u6743\u9650\u95ee\u9898\uff1aes\u7684\u6570\u636e\u76ee\u5f55\u9ed8\u8ba4\u53ea\u5141\u8bb8\u4e00\u4e2a\u8282\u70b9\u8bbf\u95ee\uff0c\u4f46\u5728k8s\u4e0a\u91c7\u7528\u4e86\u6301\u4e45\u5377\uff0c\u6240\u6709\u8282\u70b9\u7684\u6570\u636e\u90fd\u5b58\u50a8\u5728\u8fd9\u4e2a\u5377\u4e0a\uff0c\u8fd9\u4f1a\u5bfc\u81f4es\u7684\u8bbf\u95ee\u6743\u9650\u95ee\u9898\u3002\u53ef\u4ee5\u901a\u8fc7\u66f4\u6539es\u7684\u914d\u7f6emax_local_storage_nodes\u6765\u5141\u8bb8\u591a\u4e2a\u8282\u70b9\u8bbf\u95ee\u540c\u4e00\u4e2a\u6570\u636e\u76ee\u5f55\uff0c\u4f46es\u5b98\u65b9\u4e0d\u63a8\u8350\u8fd9\u6837\u505a\u3002\u6240\u4ee5\u6211\u4eec\u7684\u65b9\u6848\u662f\u66f4\u6539\u6bcf\u4e2a\u8282\u70b9\u7684\u6570\u636e\u5b58\u50a8\u76ee\u5f55\u6765\u89e3\u51b3\uff0c\u6307\u5b9aes\u914d\u7f6e\u9879path.data\u6765\u5b9e\u73b0\n            value: /usr/share/elasticsearch/data/$(POD_NAME)\n        resources:\n          limits:\n            cpu: 256m\n            memory: 1Gi\n          requests:\n            cpu: 10m\n            memory: 128Mi\n        readinessProbe: #\u53ef\u8bfb\u68c0\u67e5\n          failureThreshold: 3\n          httpGet:\n            path: /_cluster/health?local=true\n            port: 9200\n            scheme: HTTP\n          initialDelaySeconds: 5\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 1\n        securityContext: #\u7279\u6743\u7ea7\u5bb9\u5668\uff0c\u9700\u8981\u83b7\u53d6root\u6743\u9650\uff0c\u5426\u5219\u65e0\u6cd5\u5728\u4e0a\u9762\u4fee\u6539 vm.max_map_count\n          privileged: true\n        volumeMounts:\n          - name: es-config\n            mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n            subPath: elasticsearch.yml\n          - mountPath: /usr/share/elasticsearch/data\n            name: es-data\n            subPath: data\n      volumes:\n        - name: es-config\n          configMap:\n            name: es\n        - name: es-data\n            nfs:\n                path: /elasticsearch\n                server: 172.16.0.15\n")),(0,s.kt)("p",null,"\u901a\u8fc7 ",(0,s.kt)("inlineCode",{parentName:"p"},"es-out:9200")," \u8bbf\u95ee\u53ef\u5f97"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "es-1",\n  "cluster_name": "ns",\n  "cluster_uuid": "oWW0e-FbTTaskiWU2_BFxg",\n  "version": {\n    "number": "7.3.2",\n    "build_flavor": "default",\n    "build_type": "docker",\n    "build_hash": "1c1faf1",\n    "build_date": "2019-09-06T14:40:30.409026Z",\n    "build_snapshot": false,\n    "lucene_version": "8.1.0",\n    "minimum_wire_compatibility_version": "6.8.0",\n    "minimum_index_compatibility_version": "6.0.0-beta1"\n  },\n  "tagline": "You Know, for Search"\n}\n')),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"*","*","\u5927\u529f\u544a\u6210\uff01","*","*")))}m.isMDXComponent=!0}}]);